generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// Core Entities
//

model user {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String?
  provider String  @default("email")

  activeWorkspaceId String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?
  isDeleted Boolean   @default(false)

  memberships  workspaceMember[]
  files        file[]
  events       event[]
  Notification notification[]
}

model plan {
  id             String    @id @default(uuid())
  name           String
  maxMembers     Int
  maxStorage     Int       @default(340)
  monthlyCredits Int       @default(0)
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?
  isDeleted      Boolean   @default(false)
  features       Json      @default("{}")
  price          Float     @default(0)

  workspaces workspace[]
}

model workspace {
  id        String    @id @default(uuid())
  name      String
  credits   Float     @default(0)
  thumbnail String?
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  isDeleted Boolean   @default(false)

  planId String?
  plan   plan?   @relation(fields: [planId], references: [id])

  members      workspaceMember[]
  files        file[]
  events       event[]
  Notification notification[]
}

//
// Memberships & Roles
//

enum workspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum workspaceMemberStatus {
  PENDING
  ACTIVE
  REMOVED
}

model workspaceMember {
  id          String                @id @default(uuid())
  userId      String
  workspaceId String
  role        workspaceRole         @default(MEMBER)
  status      workspaceMemberStatus @default(PENDING)
  joinedAt    DateTime              @default(now())
  deletedAt   DateTime?
  isDeleted   Boolean               @default(false)

  user      user      @relation(fields: [userId], references: [id])
  workspace workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

//
// Files
//

enum fileType {
  drawing
  template
  sequence
  jobCard
  config
  table
}

model file {
  id          String    @id @default(uuid())
  workspaceId String
  uploadedBy  String
  name        String
  path        String
  type        fileType
  data        Json?
  thumbnail   String?
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)

  workspace workspace @relation(fields: [workspaceId], references: [id])
  user      user      @relation(fields: [uploadedBy], references: [id])
  events    event[]
}

//
// Events (Transactions)
//

enum eventType {
  DRAWING_DATA_EXTRACTION
  JOBCARD_GENERATION
  PLAN_CHANGE
  MANUAL_TOPUP
  SUBSCRIPTION
}

enum eventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model event {
  id           String      @id
  workspaceId  String
  userId       String
  type         eventType
  creditChange Float?      @default(0)
  balanceAfter Float?
  status       eventStatus @default(PENDING)
  progress     Float?      @default(0)
  errorData    Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  fileId       String?

  workspace workspace @relation(fields: [workspaceId], references: [id])
  File      file?     @relation(fields: [fileId], references: [id])
  user      user      @relation(fields: [userId], references: [id])
}

//
// Notifications
//

enum notificationType {
  INVITE
  ROLE_CHANGED
  REMOVED
}

model notification {
  id          String           @id @default(uuid())
  userId      String
  workspaceId String?
  type        notificationType
  message     String
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  user      user       @relation(fields: [userId], references: [id])
  workspace workspace? @relation(fields: [workspaceId], references: [id])
}
